@{
    ViewData["Title"] = "Address Management";
}

<div class="row">
    <div class="col-12">
        <h1 class="display-4">
            <i class="fas fa-map-marker-alt me-3"></i>Address Management
        </h1>
        <p class="lead">Manage member addresses for property monitoring.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus me-2"></i>Add Single Address</h5>
            </div>
            <div class="card-body">
                <form asp-action="CreateAddress" method="post">
                    <div class="mb-3">
                        <label for="InstitutionId" class="form-label">Institution ID</label>
                        <input type="text" class="form-control" id="InstitutionId" name="InstitutionId" required>
                    </div>
                    <div class="mb-3">
                        <label for="AnonymousReferenceId" class="form-label">Anonymous Reference ID</label>
                        <input type="text" class="form-control" id="AnonymousReferenceId" name="AnonymousReferenceId" required>
                    </div>
                    <div class="mb-3">
                        <label for="Address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="Address" name="Address" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="City" class="form-label">City</label>
                                <input type="text" class="form-control" id="City" name="City" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="State" class="form-label">State</label>
                                <input type="text" class="form-control" id="State" name="State" maxlength="2" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="ZipCode" class="form-label">ZIP Code</label>
                                <input type="text" class="form-control" id="ZipCode" name="ZipCode" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Add Address
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-upload me-2"></i>Bulk Upload</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="bulkInstitutionId" class="form-label">Institution ID</label>
                    <input type="text" class="form-control" id="bulkInstitutionId" required>
                </div>
                <div class="mb-3">
                    <label for="csvData" class="form-label">CSV Data</label>
                    <textarea class="form-control" id="csvData" rows="8" placeholder="anonymousReferenceId,address,city,state,zipCode&#10;member-001,123 Main St,Springfield,IL,62701&#10;member-002,456 Oak Ave,Decatur,IL,62521"></textarea>
                    <div class="form-text">Format: anonymousReferenceId,address,city,state,zipCode (one per line)</div>
                </div>
                <button type="button" class="btn btn-success" onclick="processBulkUpload()">
                    <i class="fas fa-upload me-2"></i>Upload Addresses
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list me-2"></i>Existing Addresses</h5>
                <div>
                    <input type="text" class="form-control d-inline-block" id="searchInstitution" placeholder="Institution ID" style="width: 200px;">
                    <button class="btn btn-outline-primary ms-2" onclick="loadAddresses()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="addressesTable">
                    <p class="text-muted">Enter an Institution ID and click Search to view addresses.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function processBulkUpload() {
            const institutionId = $('#bulkInstitutionId').val();
            const csvData = $('#csvData').val();
            
            if (!institutionId || !csvData) {
                alert('Please provide both Institution ID and CSV data.');
                return;
            }
            
            // Parse CSV data
            const lines = csvData.trim().split('\n');
            const addresses = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('anonymousReferenceId')) { // Skip header
                    const parts = line.split(',');
                    if (parts.length === 5) {
                        addresses.push({
                            anonymousReferenceId: parts[0].trim(),
                            address: parts[1].trim(),
                            city: parts[2].trim(),
                            state: parts[3].trim(),
                            zipCode: parts[4].trim()
                        });
                    }
                }
            }
            
            if (addresses.length === 0) {
                alert('No valid addresses found in CSV data.');
                return;
            }
            
            // Create form and submit
            const form = $('<form>', {
                method: 'POST',
                action: '@Url.Action("BulkUpload")'
            });
            
            form.append($('<input>', {
                type: 'hidden',
                name: 'InstitutionId',
                value: institutionId
            }));
            
            addresses.forEach((addr, index) => {
                Object.keys(addr).forEach(key => {
                    form.append($('<input>', {
                        type: 'hidden',
                        name: `Addresses[${index}].${key.charAt(0).toUpperCase() + key.slice(1)}`,
                        value: addr[key]
                    }));
                });
            });
            
            $('body').append(form);
            form.submit();
        }
        
        function loadAddresses() {
            const institutionId = $('#searchInstitution').val();
            if (!institutionId) {
                alert('Please enter an Institution ID.');
                return;
            }
            
            $('#addressesTable').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
            
            $.get('@Url.Action("GetAddresses")', { institutionId: institutionId })
                .done(function(data) {
                    if (data.error) {
                        $('#addressesTable').html('<div class="alert alert-danger">' + data.error + '</div>');
                        return;
                    }
                    
                    if (data.length === 0) {
                        $('#addressesTable').html('<div class="alert alert-info">No addresses found for this institution.</div>');
                        return;
                    }
                    
                    let html = '<div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>Reference ID</th><th>Address</th><th>City</th><th>State</th><th>ZIP</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                    
                    data.forEach(function(addr) {
                        html += '<tr>';
                        html += '<td>' + addr.anonymousReferenceId + '</td>';
                        html += '<td>' + addr.address + '</td>';
                        html += '<td>' + addr.city + '</td>';
                        html += '<td>' + addr.state + '</td>';
                        html += '<td>' + addr.zipCode + '</td>';
                        html += '<td>' + new Date(addr.createdDate).toLocaleDateString() + '</td>';
                        html += '<td><button class="btn btn-sm btn-danger" onclick="deleteAddress(\'' + addr.id + '\', \'' + institutionId + '\')"><i class="fas fa-trash"></i></button></td>';
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    $('#addressesTable').html(html);
                })
                .fail(function() {
                    $('#addressesTable').html('<div class="alert alert-danger">Error loading addresses.</div>');
                });
        }
        
        function deleteAddress(id, institutionId) {
            if (!confirm('Are you sure you want to delete this address?')) {
                return;
            }
            
            $.post('@Url.Action("DeleteAddress")', { id: id, institutionId: institutionId })
                .done(function(data) {
                    if (data.success) {
                        loadAddresses(); // Reload the table
                    } else {
                        alert('Error deleting address: ' + (data.error || 'Unknown error'));
                    }
                })
                .fail(function() {
                    alert('Error deleting address.');
                });
        }
    </script>
}
